package main.vulnerability;

import main.ast.baseNodes_DIR.Program;
import main.ast.baseNodes_DIR.TranslationUnit;
import main.ast.declaration_DIR.*;
import main.ast.expression_DIR.*;
import main.ast.literal_DIR.*;
import main.ast.mainNodes_DIR.Declaration;
import main.ast.mainNodes_DIR.Expr;
import main.ast.mainNodes_DIR.Pointer;
import main.ast.statement_DIR.*;
import main.symbolTable.SymbolTable;
import main.symbolTable.exceptions.ItemAlreadyExistsException;
import main.symbolTable.exceptions.ItemNotFoundException;
import main.symbolTable.item.FuncDecSymbolTableItem;
import main.symbolTable.item.VarDecSymbolTableItem;
import main.visitor.Visitor;


public class VulnerabilityDataCollector extends Visitor<Void> {

    public SymbolTable symbolTableMain;
    public boolean analysisSucceeded = true;

    // State flags for context-sensitive logic
    private boolean isWithinVariableDeclaration = false;
    private String currentDeclarationType = "";
    private boolean isDefiningFunctionArgs = false;

    @Override
    public Void visit(Program program) {
        SymbolTable.top = new SymbolTable();
        SymbolTable.root = SymbolTable.top;
        program.setSymbolTable(SymbolTable.top);
        program.getTranslationUnit().accept(this);
        this.symbolTableMain = SymbolTable.top;
        return null;
    }

    @Override
    public Void visit(TranslationUnit translationUnit) {
        for (ExternalDeclaration externalDeclaration : translationUnit.getExternalDeclaration()) {
            externalDeclaration.accept(this);
        }
        return null;
    }

    @Override
    public Void visit(ExternalDeclaration externalDeclaration) {
        if (externalDeclaration.getDeclaration() != null) {
            externalDeclaration.getDeclaration().accept(this);
        } else {
            externalDeclaration.getFunctionDefinition().accept(this);
        }
        return null;
    }


    @Override
    public Void visit(FunctionDefinition functionDefinition) {
        ParameterList paramList = functionDefinition.getDeclarator().getDirectDec().getParameterList();
        functionDefinition.setNumArgs(paramList == null ? 0 : paramList.getParameterDecs().size());

        FuncDecSymbolTableItem functionItem = new FuncDecSymbolTableItem(functionDefinition);
        functionItem.type = functionDefinition.getDecSpecifiers().getDeclarationSpecifiers().get(0).getTypeSpecifier().getType();
        try {
            SymbolTable.top.put(functionItem);
        } catch (ItemAlreadyExistsException e) {
            String functionName = functionDefinition.getDeclarator().getDirectDec().getDirectDec().getIdentifier();
            int line = functionDefinition.getDeclarator().getDirectDec().getDirectDec().getLine();
            System.out.println("Redefinition of function \"" + functionName + "\" in line " + line);
            analysisSucceeded = false;
        }

        SymbolTable functionScope = new SymbolTable(SymbolTable.top);
        functionDefinition.setSymbolTable(functionScope);
        SymbolTable.push(functionScope);

        functionDefinition.getDeclarator().accept(this);
        if (functionDefinition.getDecList() != null) {
            functionDefinition.getDecList().accept(this);
        }
        functionDefinition.getCompoundStmt().accept(this);

        SymbolTable.pop();
        return null;
    }

    @Override
    public Void visit(Declaration declaration) {
        this.isWithinVariableDeclaration = true;
        this.currentDeclarationType = declaration.getDeclarationSpecifiers().getDeclarationSpecifiers().get(0).getTypeSpecifier().getType();

        declaration.getDeclarationSpecifiers().accept(this);
        if (declaration.getInitDeclaratorList() != null) {
            declaration.getInitDeclaratorList().accept(this);
        }

        this.isWithinVariableDeclaration = false;
        return null;
    }

    @Override
    public Void visit(Declarator declarator) {
        declarator.getDirectDec().accept(this);
        if (declarator.getPointer() != null) {
            declarator.getPointer().accept(this);
        }

        DirectDec directDec = declarator.getDirectDec();
        while (directDec.getIdentifier().isEmpty()) {
            directDec = directDec.getDirectDec();
        }

        if (!directDec.getIdentifier().isEmpty()) {
            TypeSpecifier typeSpecifier = new TypeSpecifier(directDec.getIdentifier());
            typeSpecifier.setLine(directDec.getLine());
            directDec.setTypeSpecifier(typeSpecifier);

            VarDecSymbolTableItem varItem = new VarDecSymbolTableItem(typeSpecifier);
            varItem.isFree = (declarator.getPointer() == null);
            varItem.isInit = isDefiningFunctionArgs;
            if (isWithinVariableDeclaration) {
                varItem.type = currentDeclarationType;
            }

            try {
                SymbolTable.top.put(varItem);
            } catch (ItemAlreadyExistsException e) {
                System.out.println("Redeclaration of variable \"" + typeSpecifier.getType() + "\" in line " + typeSpecifier.getLine());
                analysisSucceeded = false;
            }
        }
        return null;
    }

    @Override
    public Void visit(InitDeclarator initDeclarator) {
        initDeclarator.getDeclarator().accept(this);

        String identifier = initDeclarator.getDeclarator().getDirectDec().getIdentifier();

        if (initDeclarator.getDeclarator().getPointer() != null) {
            try {
                VarDecSymbolTableItem item = (VarDecSymbolTableItem) SymbolTable.top.getItem(VarDecSymbolTableItem.START_KEY + identifier);
                item.isFree = true;
                item.isPtr = true;
            } catch (ItemNotFoundException ignored) {}
        }

        if (initDeclarator.getInitializer() != null) {
            if (initDeclarator.getInitializer().getExpr() instanceof FuncCall &&
                    ((Identifier) ((FuncCall) initDeclarator.getInitializer().getExpr()).getExpr()).getIdentifier().equals("malloc")) {
                try {
                    VarDecSymbolTableItem item = (VarDecSymbolTableItem) SymbolTable.top.getItem(VarDecSymbolTableItem.START_KEY + identifier);
                    item.isFree = false;
                    item.isPtr = true;
                } catch (ItemNotFoundException ignored) {}
            }
            try {
                VarDecSymbolTableItem item = (VarDecSymbolTableItem) SymbolTable.top.getItem(VarDecSymbolTableItem.START_KEY + identifier);
                item.isInit = true;
            } catch (ItemNotFoundException ignored) {}

            initDeclarator.getInitializer().accept(this);
        }
        return null;
    }

    @Override
    public Void visit(ParameterList parameterList) {
        this.isDefiningFunctionArgs = true;
        for (ParameterDec parameterDec : parameterList.getParameterDecs()) {
            parameterDec.accept(this);
        }
        this.isDefiningFunctionArgs = false;
        return null;
    }

    @Override
    public Void visit(ParameterDec parameterDec) {
        this.isWithinVariableDeclaration = true;
        this.currentDeclarationType = parameterDec.getDeclarationSpecifier().getDeclarationSpecifiers().get(0).getTypeSpecifier().getType();

        parameterDec.getDeclarationSpecifier().accept(this);
        if (parameterDec.getDeclarator() != null) {
            parameterDec.getDeclarator().accept(this);
            if (parameterDec.getDeclarator().getPointer() != null) {
                String identifier = parameterDec.getDeclarator().getDirectDec().getIdentifier();
                try {
                    VarDecSymbolTableItem item = (VarDecSymbolTableItem) SymbolTable.top.getItem(VarDecSymbolTableItem.START_KEY + identifier);
                    item.isFree = false;
                } catch (ItemNotFoundException ignored) {}
            }
        }

        this.isWithinVariableDeclaration = false;

        if (parameterDec.getAbstractDec() != null) {
            parameterDec.getAbstractDec().accept(this);
        }
        return null;
    }

    @Override
    public Void visit(TypeSpecifier typeSpecifier) {
        try {
            TypeSpecifier resolvedTypedef = ((VarDecSymbolTableItem) SymbolTable.top
                    .getItem(VarDecSymbolTableItem.START_KEY + typeSpecifier.getType())).getVarDec();

            if (resolvedTypedef.isTypeDef()) {
                typeSpecifier.setType(resolvedTypedef.getTypeDefName());
                typeSpecifier.setNotVarDec();
            }
        } catch (ItemNotFoundException ignored) {
            // Not a typedef or not found.
        }

        if (typeSpecifier.isVar_dec()) {
            VarDecSymbolTableItem varItem = new VarDecSymbolTableItem(typeSpecifier);
            if (isWithinVariableDeclaration) {
                varItem.type = currentDeclarationType;
            }
            varItem.isInit = isDefiningFunctionArgs;

            try {
                SymbolTable.top.put(varItem);
            } catch (ItemAlreadyExistsException e) {
                System.out.println("Redeclaration of variable \"" + typeSpecifier.getType() + "\" in line " + typeSpecifier.getLine());
                analysisSucceeded = false;
            }
        }
        return null;
    }

    @Override
    public Void visit(FuncCall funcCall) {
        String funcName = ((Identifier) funcCall.getExpr()).getIdentifier();
        ((Identifier) funcCall.getExpr()).setFunc();

        if (funcName.equals("scanf")) {
            handleScanfTainting(funcCall);
        }

        if (funcName.equals("free")) {
            if (funcCall.getArgExpr() != null && !funcCall.getArgExpr().getExprs().isEmpty()) {
                markPointerAsFreed(funcCall.getArgExpr().getExprs().get(0));
            }
        }

        if (!isBuiltInFunction(funcName)) {
            try {
                FuncDecSymbolTableItem funcItem = (FuncDecSymbolTableItem) SymbolTable.top.getItem(FuncDecSymbolTableItem.START_KEY + funcCall.getNumArgs() + funcName);
                FunctionDefinition funcDef = funcItem.getFuncDec();

                if (funcCall.getArgExpr() != null) {
                    for (int i = 0; i < funcCall.getArgExpr().getExprs().size(); i++) {
                        ParameterDec pd = funcDef.getDeclarator().getDirectDec().getParameterList().getParameterDecs().get(i);
                        String paramName = pd.getDeclarator() != null ? pd.getDeclarator().getDirectDec().getIdentifier() : pd.getDeclarationSpecifier().getDeclarationSpecifiers().get(pd.getDeclarationSpecifier().getDeclarationSpecifiers().size() - 1).getTypeSpecifier().getType();
                        VarDecSymbolTableItem paramItem = (VarDecSymbolTableItem) funcDef.getSymbolTable().getItem(VarDecSymbolTableItem.START_KEY + paramName);
                        if (paramItem.isFree) {
                            markPointerAsFreed(funcCall.getArgExpr().getExprs().get(i));
                        }
                    }
                }
            } catch (ItemNotFoundException e) {
                int line = ((Identifier) funcCall.getExpr()).getLine();
                System.out.println("Line:" + line + "-> " + funcName + " not declared");
            }
        }

        funcCall.getExpr().accept(this);
        if (funcCall.getArgExpr() != null) {
            funcCall.getArgExpr().accept(this);
        }
        return null;
    }

    @Override
    public Void visit(BinaryExpr binaryExpr) {
        binaryExpr.getExpr1().accept(this);
        binaryExpr.getExpr2().accept(this);

        if (binaryExpr.getAssignmentOp() != null) {
            binaryExpr.getAssignmentOp().accept(this);

            if (binaryExpr.getAssignmentOp().getOpType().equals("=")) {
                if (binaryExpr.getExpr1() instanceof Identifier) {
                    String identifier = ((Identifier) binaryExpr.getExpr1()).getIdentifier();
                    try {
                        VarDecSymbolTableItem item = (VarDecSymbolTableItem) SymbolTable.top.getItem(VarDecSymbolTableItem.START_KEY + identifier);
                        item.isInit = true;

                        if (binaryExpr.getExpr2() instanceof FuncCall &&
                                ((Identifier) ((FuncCall) binaryExpr.getExpr2()).getExpr()).getIdentifier().equals("malloc")) {
                            item.isFree = false;
                        }
                    } catch (ItemNotFoundException e) {
                        analysisSucceeded = false;
                    }
                }
            }
        }
        return null;
    }

    @Override
    public Void visit(Identifier identifier) {
        // This vulnerability check is preserved here as per the original logic.
        if (!identifier.isFunc() && !identifier.getIdentifier().startsWith("\"")) {
            try {
                VarDecSymbolTableItem item = (VarDecSymbolTableItem) SymbolTable.top.getItem(VarDecSymbolTableItem.START_KEY + identifier.getIdentifier());
                if (!item.isInit) {
                    System.out.println("Line:" + identifier.getLine() + " -> uninitialized variable used");
                    item.isInit = true; // Mark to avoid repeated errors.
                }
            } catch (ItemNotFoundException e) {
                System.out.println("Line:" + identifier.getLine() + "-> " + identifier.getIdentifier() + " not declared");
                analysisSucceeded = false;
            }
        }
        return null;
    }


    private void handleScanfTainting(FuncCall scanfCall) {
        if (scanfCall.getArgExpr() == null) return;

        for (Expr expr : scanfCall.getArgExpr().getExprs()) {
            if (expr instanceof PrefixExpr) {
                CastExpr castExpr = ((PrefixExpr) expr).getCastExpr();
                if (castExpr != null && castExpr.getExpr() instanceof Identifier) {
                    String identifier = ((Identifier) castExpr.getExpr()).getIdentifier();
                    try {
                        VarDecSymbolTableItem item = (VarDecSymbolTableItem) SymbolTable.top.getItem(VarDecSymbolTableItem.START_KEY + identifier);
                        item.isInit = true;
                        item.fromUser = true;
                    } catch (ItemNotFoundException ignored) {
                        break;
                    }
                }
            }
        }
    }

    private void markPointerAsFreed(Expr expr) {
        if (!(expr instanceof Identifier)) return;

        Identifier identifier = (Identifier) expr;
        try {
            VarDecSymbolTableItem item = (VarDecSymbolTableItem) SymbolTable.top.getItem(VarDecSymbolTableItem.START_KEY + identifier.getIdentifier());
            item.isFree = true;
        } catch (ItemNotFoundException e) {
            System.out.println("Line:" + identifier.getLine() + "-> " + identifier.getIdentifier() + " not declared");
            analysisSucceeded = false;
        }
    }

    private boolean isBuiltInFunction(String funcName) {
        return funcName.equals("scanf") || funcName.equals("printf") || funcName.equals("malloc") || funcName.equals("free");
    }

    public Void visit(CastExpr castExpr) {
        if (castExpr.getCastExpr() != null) castExpr.getCastExpr().accept(this);
        if (castExpr.getExpr() != null) castExpr.getExpr().accept(this);
        if (castExpr.getTypeName() != null) castExpr.getTypeName().accept(this);
        return null;
    }
    public Void visit(DecList decList) {
        for (Declaration declaration : decList.getDeclarations()) declaration.accept(this);
        return null;
    }
    public Void visit(DeclarationSpecifiers declarationSpecifiers) {
        for (DeclarationSpecifier declarationSpecifier : declarationSpecifiers.getDeclarationSpecifiers())
            declarationSpecifier.accept(this);
        if (declarationSpecifiers.getDeclarationSpecifiers().get(0).getType() != null
                && declarationSpecifiers.getDeclarationSpecifiers().get(0).getType().equals("typedef"))
            declarationSpecifiers.getDeclarationSpecifiers().get(declarationSpecifiers.getDeclarationSpecifiers().size() - 1).getTypeSpecifier()
                    .setTypeDef(declarationSpecifiers.getDeclarationSpecifiers().get(1).getType());
        return null;
    }
    public Void visit(ForDec forDec) {
        forDec.getDeclarationSpecifiers().accept(this);
        if (forDec.getInitDecList() != null) forDec.getInitDecList().accept(this);
        return null;
    }
    public Void visit(DeclarationSpecifier declarationSpecifier) {
        if (declarationSpecifier.getTypeSpecifier() != null) declarationSpecifier.getTypeSpecifier().accept(this);
        return null;
    }
    public Void visit(InitDeclaratorList initDeclaratorList) {
        for (InitDeclarator initDeclarator : initDeclaratorList.getInitDeclarators()) {
            if (initDeclaratorList.getInitDeclarators().get(0).getDeclarator().getPointer() != null)
                initDeclarator.getDeclarator().setPointer(new Pointer());
            initDeclarator.accept(this);
        }
        return null;
    }
    public Void visit(ArgExpr argExpr) {
        for (Expr expr : argExpr.getExprs()) if (expr != null) expr.accept(this);
        return null;
    }
    public Void visit(UnaryOperator unaryOperator) { return null; }
    public Void visit(AssignmentOp assignmentOp) { return null; }
    public Void visit(Pointer pointer) { return null; }
    public Void visit(DirectDec directDec) {
        if (directDec.getDeclarator() != null) directDec.getDeclarator().accept(this);
        if (directDec.getDirectDec() != null) directDec.getDirectDec().accept(this);
        if (directDec.getIdentifierList() != null) directDec.getIdentifierList().accept(this);
        if (directDec.getExpr() != null) directDec.getExpr().accept(this);
        if (directDec.getParameterList() != null) directDec.getParameterList().accept(this);
        return null;
    }
    public Void visit(SpecifierQualifierList specifierQualifierList) {
        if (specifierQualifierList.getTypeSpecifier() != null) specifierQualifierList.getTypeSpecifier().accept(this);
        if (specifierQualifierList.getSpecifierQualifierList() != null) specifierQualifierList.getSpecifierQualifierList().accept(this);
        return null;
    }
    public Void visit(IdentifierList identifierList) { return null; }
    public Void visit(TypeName typeName) {
        typeName.getSpecifierQualifierList().accept(this);
        if (typeName.getAbstractDec() != null) typeName.getAbstractDec().accept(this);
        return null;
    }
    public Void visit(DirectAbsDec directAbsDec) {
        if (directAbsDec.getExpr() != null) directAbsDec.getExpr().accept(this);
        if (directAbsDec.getAbstractDec() != null) directAbsDec.getAbstractDec().accept(this);
        if (directAbsDec.getParameterList() != null) directAbsDec.getParameterList().accept(this);
        if (directAbsDec.getDirectAbsDec() != null) directAbsDec.getDirectAbsDec().accept(this);
        return null;
    }
    public Void visit(AbstractDec abstractDec) {
        if(abstractDec.getPointer() != null) abstractDec.getPointer().accept(this);
        if (abstractDec.getDirectAbsDec() != null) abstractDec.getDirectAbsDec().accept(this);
        return null;
    }
    public Void visit(Initializer initializer) {
        if (initializer.getExpr() != null) initializer.getExpr().accept(this);
        else initializer.getInitList().accept(this);
        return null;
    }
    public Void visit(InitializerList initializerList) {
        for (Initializer initializer : initializerList.getInitializers()) initializer.accept(this);
        for (Designation designation : initializerList.getDesignations()) designation.accept(this);
        return null;
    }
    public Void visit(Designation designation) {
        for (Designator designator : designation.getDesignators()) designator.accept(this);
        return null;
    }
    public Void visit(Designator designator) {
        if (designator.getExpr() != null) designator.getExpr().accept(this);
        return null;
    }
    public Void visit(CompoundStmt compoundStmt) {
        for (BlockItem blockItem : compoundStmt.getBlockItems()) {
            blockItem.accept(this);
        }
        return null;
    }
    public Void visit(BlockItem blockItem) {
        if (blockItem.getStmt() != null) blockItem.getStmt().accept(this);
        else blockItem.getDeclaration().accept(this);
        return null;
    }
    public Void visit(ExprStmt exprStmt) {
        if (exprStmt.getExpr() != null) exprStmt.getExpr().accept(this);
        return null;
    }
    public Void visit(SelectionStmt selectionStmt) {
        SymbolTable symbolTable = new SymbolTable(SymbolTable.top);
        selectionStmt.setSymbolTable(symbolTable);
        SymbolTable.push(symbolTable);
        selectionStmt.getExpr().accept(this);
        selectionStmt.getMainStmt().accept(this);
        if (selectionStmt.getElseStmt() != null) selectionStmt.getElseStmt().accept(this);
        SymbolTable.pop();
        return null;
    }
    public Void visit(IterStmt iterStmt) {
        SymbolTable symbolTable = new SymbolTable(SymbolTable.top);
        iterStmt.setSymbolTable(symbolTable);
        SymbolTable.push(symbolTable);
        if (iterStmt.getForCondition() != null) iterStmt.getForCondition().accept(this);
        if (iterStmt.getExpr() != null) iterStmt.getExpr().accept(this);
        if (iterStmt.getStmt() != null) iterStmt.getStmt().accept(this);
        SymbolTable.pop();
        return null;
    }
    public Void visit(ForCondition forCondition) {
        if (forCondition.getForDec() != null) forCondition.getForDec().accept(this);
        if (forCondition.getExpr() != null) forCondition.getExpr().accept(this);
        if (forCondition.getForExpr1() != null) forCondition.getForExpr1().accept(this);
        if (forCondition.getForExpr2() != null) forCondition.getForExpr2().accept(this);
        return null;
    }
    public Void visit(ForExpr forExpr) {
        for (Expr expr : forExpr.getExprs()) { if (expr != null) expr.accept(this); }
        return null;
    }
    public Void visit(JumpStmt jumpStmt) {
        if (jumpStmt.getCondition() != null) jumpStmt.getCondition().accept(this);
        return null;
    }
    public Void visit(UnaryExpr unaryExpr) {
        unaryExpr.getExpr().accept(this);
        return null;
    }
    public Void visit(ExprCast exprCast) {
        exprCast.getCastExpr().accept(this);
        exprCast.getTypeName().accept(this);
        return null;
    }
    public Void visit(CondExpr condExpr) {
        condExpr.getExpr1().accept(this);
        condExpr.getExpr2().accept(this);
        condExpr.getExpr3().accept(this);
        return null;
    }
    public Void visit(CommaExpr commaExpr) {
        for (Expr expr : commaExpr.getExprs()) if (expr != null) expr.accept(this);
        return null;
    }
    public Void visit(ArrayIndexing arrayIndexing) {
        arrayIndexing.getExpr1().accept(this);
        arrayIndexing.getExpr2().accept(this);
        return null;
    }
    public Void visit(Constant constant) { return null; }
    public Void visit(TIExpr tiExpr) {
        tiExpr.getInitializerList().accept(this);
        tiExpr.getTypeName().accept(this);
        return null;
    }
    public Void visit(PrefixExpr prefixExpr) {
        if (prefixExpr.getExpr() != null) prefixExpr.getExpr().accept(this);
        if (prefixExpr.getCastExpr() != null) prefixExpr.getCastExpr().accept(this);
        if (prefixExpr.getTypeName() != null) prefixExpr.getTypeName().accept(this);
        if (prefixExpr.getTIExpr() != null) prefixExpr.getTIExpr().accept(this);
        if (prefixExpr.getUnaryOp() != null) prefixExpr.getUnaryOp().accept(this);
        return null;
    }
}